SELECT  
    AC_PERSONCONTACTID
    ,TRANSACTION_ID
    ,ASSET_ID
    ,AC_ID
    ,AC_RICSC_CLIENTID
    ,EM_RICSC_EMAIL
    ,PH_RICSC_PHONENOSPACES
    ,AC_FIRSTNAME
    ,AC_LASTNAME
    ,AC_RICSC_OTHERFIRSTNAME
    ,AC_RICSC_OTHERLASTNAME
    ,AC_RICSC_FULLNAME
    ,AC_PERSONTITLE
    ,AC_RICSC_GENDER
    ,AC_RICSC_DATAORIGIN
    ,AC_RICSC_SPOKENLANGUAGE
    ,AC_RICSC_WRITTENLANGUAGE
    ,SALUTATION
    ,AC_PERSONBIRTHDATE
    ,AC_RICSC_PARTNERBIRTHDAY
    ,AC_RICSC_WEDDINGDATE
    ,AC_RICSC_AGE
    ,AC_RICSC_DEFAULTADDRESSTYPE
    ,AC_RICSC_DEFAULTSTREET
    ,AC_RICSC_DEFAULTCITY
    ,AC_RICSC_DEFAULTCOUNTRY
    ,AC_RICSC_DEFAULTPOSTALCODE
    ,AC_RICSC_COUNTRYOFORIGIN
    ,AC_RICSC_COUNTRYOFRESIDENCE
    ,AC_RICSC_LASTPURCHASEMARKET
    ,AC_RICSC_REFERENCEMARKET
    ,AC_RICSC_CLIENTSEGMENT
    ,AC_RICSC_ESEGMENT
    ,AC_RICSC_GLOBALSEGMENT
    ,AC_RICSC_CLASSCODE
    ,AC_RICSC_CANBECONTACTED
    ,AC_RICSC_ELECTRONICCONTACT
    ,AC_RICSC_POSTALCONTACT
    ,AC_RICSC_VOICECONTACT
    ,AC_RICSC_FIRSTSALESDATE
    ,AC_RICSC_LASTSALESDATE
    ,AC_RICSC_FIRSTTRANSACTIONDATE
    ,AC_RICSC_LASTTRANSACTIONDATE
    ,AC_RICSC_TOTALNUMBEROFSALES
    ,AC_RICSC_TOTALNUMBEROFREPAIRS
    ,AC_RICSC_TOTALNUMBEROFTRANSACTIONS
    ,AC_RICSC_EXTCREATIONDATE
    ,TRAVELER_SEGMENT
    ,TRAVELER_SEGMENT_MARKET
    ,COUNTRY
    ,BOUTIQUE_ID
    ,BOUTIQUE_EXTERNALID
    ,BOUTIQUE_LABEL
    ,BOUTIQUE_MAISON
    ,BOUTIQUE_COUNTRY
    ,EMPLOYEERESPONSIBLE_CONTACT
    ,EMPLOYEERESPONSIBLE_USER
    ,OWNERID
    ,RICSC_JOURNEYGUID
    ,MC_DATAOWNER
    ,MC_POOLLANGUAGE
    ,LOCALE
    ,POOLLANGUAGE
    ,BoutiqueId
    ,ExternalKey
    ,CONTROLRANK
FROM (
    SELECT  
        ROW_NUMBER() OVER (PARTITION BY _CUSTOMER.EM_RICSC_EMAIL ORDER BY _CUSTOMER.AC_RICSC_EXTCREATIONDATE DESC) AS ROWNUMBER
        ,_CUSTOMER.AC_PERSONCONTACTID
        ,'' AS TRANSACTION_ID
        ,'' AS ASSET_ID
        ,_CUSTOMER.AC_ID
        ,_CUSTOMER.AC_RICSC_CLIENTID
        ,_CUSTOMER.EM_RICSC_EMAIL
        ,_CUSTOMER.PH_RICSC_PHONENOSPACES
        ,_CUSTOMER.AC_FIRSTNAME
        ,_CUSTOMER.AC_LASTNAME
        ,_CUSTOMER.AC_RICSC_OTHERFIRSTNAME
        ,_CUSTOMER.AC_RICSC_OTHERLASTNAME
        ,_CUSTOMER.AC_RICSC_FULLNAME
        ,_CUSTOMER.AC_RICSC_TITLE AS AC_PERSONTITLE
        ,_CUSTOMER.AC_RICSC_GENDER
        ,_CUSTOMER.AC_RICSC_DATAORIGIN
        ,_CUSTOMER.AC_RICSC_SPOKENLANGUAGE
        ,_CUSTOMER.AC_RICSC_WRITTENLANGUAGE
        ,'' AS SALUTATION
        ,_CUSTOMER.AC_PERSONBIRTHDATE
        ,_CUSTOMER.AC_RICSC_PARTNERBIRTHDAY
        ,_CUSTOMER.AC_RICSC_WEDDINGDATE
        ,_CUSTOMER.AC_RICSC_AGE
        ,_CUSTOMER.AC_RICSC_DEFAULTADDRESSTYPE
        ,_CUSTOMER.AC_RICSC_DEFAULTSTREET
        ,_CUSTOMER.AC_RICSC_DEFAULTCITY
        ,_CUSTOMER.AC_RICSC_DEFAULTCOUNTRY
        ,_CUSTOMER.AC_RICSC_DEFAULTPOSTALCODE
        ,_CUSTOMER.AC_RICSC_COUNTRYOFORIGIN
        ,_CUSTOMER.AC_RICSC_COUNTRYOFRESIDENCE
        ,_CUSTOMER.AC_RICSC_LASTPURCHASEMARKET
        ,_CUSTOMER.AC_RICSC_REFERENCEMARKET
        ,_CUSTOMER.AC_RICSC_CLIENTSEGMENT
        ,_CUSTOMER.AC_RICSC_ESEGMENT
        ,_CUSTOMER.AC_RICSC_GLOBALSEGMENT
        ,_CUSTOMER.AC_RICSC_CLASSCODE
        ,_CUSTOMER.AC_RICSC_CANBECONTACTED
        ,_CUSTOMER.AC_RICSC_ELECTRONICCONTACT
        ,_CUSTOMER.AC_RICSC_POSTALCONTACT
        ,_CUSTOMER.AC_RICSC_VOICECONTACT
        ,_CUSTOMER.AC_RICSC_FIRSTSALESDATE
        ,_CUSTOMER.AC_RICSC_LASTSALESDATE
        ,_CUSTOMER.AC_RICSC_FIRSTTRANSACTIONDATE
        ,_CUSTOMER.AC_RICSC_LASTTRANSACTIONDATE
        ,_CUSTOMER.AC_RICSC_TOTALNUMBEROFSALES
        ,_CUSTOMER.AC_RICSC_TOTALNUMBEROFREPAIRS
        ,_CUSTOMER.AC_RICSC_TOTALNUMBEROFTRANSACTIONS
        ,_CUSTOMER.AC_RICSC_EXTCREATIONDATE
        ,_CUSTOMER.AC_RICSC_RESIDENTNONRESIDENT_CARFORMULA AS TRAVELER_SEGMENT
        ,_CUSTOMER.MC_CENTRAL_ONE_TO_MANY AS TRAVELER_SEGMENT_MARKET
        ,'##country##' AS COUNTRY
        ,BOUTIQUE.ID AS BOUTIQUE_ID
        ,BOUTIQUE.RICSC_EXTERNALID AS BOUTIQUE_EXTERNALID
        ,ISNULL(BOUTIQUE.MC_BOUTIQUELABEL, BOUTIQUE.NAME) AS BOUTIQUE_LABEL
        ,BOUTIQUE.RICSC_MAISON AS BOUTIQUE_MAISON
        ,BOUTIQUE.RICSC_COUNTRYOFORIGIN AS BOUTIQUE_COUNTRY
        ,BOUTIQUESTAFF.ID AS EMPLOYEERESPONSIBLE_CONTACT
        ,[USER].ID AS EMPLOYEERESPONSIBLE_USER
        ,[USER].ID AS OWNERID
        ,NEWID() AS RICSC_JOURNEYGUID
        ,_CUSTOMER.MC_DATAOWNER
        ,_CUSTOMER.MC_POOLLANGUAGE
        ,_CUSTOMER.LOCALE
        ,'FR' AS POOLLANGUAGE
        ,REPLACE(BOUTIQUE.RICSC_EXTERNALID, 'GEMINI_', 'B') AS BoutiqueId
        ,##external_key## AS ExternalKey
        ,NTILE(20) OVER(ORDER BY _CUSTOMER.AC_PERSONCONTACTID) AS CONTROLRANK
    FROM ##table_name##
    LEFT OUTER JOIN BOUTIQUESTAFF ON _CUSTOMER.AC_RICSC_REFERENCESA = BOUTIQUESTAFF.ID AND BOUTIQUESTAFF.LASTNAME NOT LIKE '#%'
    LEFT OUTER JOIN BOUTIQUE ON BOUTIQUESTAFF.ACCOUNTID = BOUTIQUE.ID
    LEFT OUTER JOIN [USER] ON BOUTIQUESTAFF.RICSC_EXTERNALID = [USER].RICSC_EXTERNALID
    LEFT OUTER JOIN ENT._BOUNCE ON _BOUNCE.SUBSCRIBERKEY = _CUSTOMER.AC_PERSONCONTACTID AND _BOUNCE.BOUNCECATEGORY = 'HARD BOUNCE'
    LEFT OUTER JOIN ENT._UNSUBSCRIBE ON _UNSUBSCRIBE.SUBSCRIBERKEY = _CUSTOMER.AC_PERSONCONTACTID
    LEFT OUTER JOIN CAREU_WSP_CUSTOMERS ON CAREU_WSP_CUSTOMERS.AC_PERSONCONTACTID = _CUSTOMER.AC_PERSONCONTACTID

    WHERE   _BOUNCE.SUBSCRIBERKEY IS NULL
        AND _UNSUBSCRIBE.SUBSCRIBERKEY IS NULL
        AND CAREU_WSP_CUSTOMERS.AC_PERSONCONTACTID IS NULL
        AND _CUSTOMER.AC_RICSC_CANBECONTACTED = 1
        AND ((_CUSTOMER.AC_RICSC_ELECTRONICCONTACT = 1
                AND _CUSTOMER.EM_RICSC_EMAILTYPE <> '8'
                AND LEN(ISNULL(LTRIM(RTRIM(_CUSTOMER.EM_RICSC_EMAIL)), '')) > 0
                AND LTRIM(RTRIM(_CUSTOMER.EM_RICSC_EMAIL)) NOT IN ('@','#')
                AND _CUSTOMER.EM_RICSC_EMAIL NOT LIKE '%@CARTIER.COM%'
                AND _CUSTOMER.EM_RICSC_EMAIL NOT LIKE '%@RICHEMONT.COM%'))
        AND _CUSTOMER.AC_RICSC_CLASSCODE NOT LIKE '%WHOLESALE%'
        AND _CUSTOMER.MC_CENTRAL_ONE_TO_MANY = '##central_one_to_many##'
        
) AS CUSTOMERS
WHERE   CUSTOMERS.ROWNUMBER = 1
